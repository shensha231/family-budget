{% extends "base.html" %}
{% block title %}–°–∏–º—É–ª—è—Ç–æ—Ä –±—é–¥–∂–µ—Ç–∞ ¬∑ Family Budget{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="row g-4">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="col-12">
      <div class="text-center mb-4">
        <h1 class="h3 mb-2">üéØ –°–∏–º—É–ª—è—Ç–æ—Ä –±—é–¥–∂–µ—Ç–∞ "–ß—Ç–æ –µ—Å–ª–∏?"</h1>
        <p class="text-muted-soft">–°–ø–ª–∞–Ω–∏—Ä—É–π—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –±—é–¥–∂–µ—Ç–µ –∏ –ø–æ–ª—É—á–∏—Ç–µ AI-–∞–Ω–∞–ª–∏–∑ –æ—Ç DeepSeek</p>
      </div>
    </div>

    <!-- –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
    <div class="col-md-4">
      <div class="fb-card p-4 h-100">
        <h2 class="h6 text-muted-soft mb-3">üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ</h2>
        <div class="mb-3">
          <p class="mb-1 text-muted-soft">–°—Ä–µ–¥–Ω–∏–π –¥–æ—Ö–æ–¥:</p>
          <p class="h5 text-income mb-0">{{ current_stats.avg_income or 0 }} ‚ÇΩ/–º–µ—Å</p>
        </div>
        <div class="mb-3">
          <p class="mb-1 text-muted-soft">–°—Ä–µ–¥–Ω–∏–π —Ä–∞—Å—Ö–æ–¥:</p>
          <p class="h5 text-expense mb-0">{{ current_stats.avg_expense or 0 }} ‚ÇΩ/–º–µ—Å</p>
        </div>
        <div class="mb-3">
          <p class="mb-1 text-muted-soft">–ë–∞–ª–∞–Ω—Å:</p>
          <p class="h5 mb-0">{{ current_stats.balance or 0 }} ‚ÇΩ/–º–µ—Å</p>
        </div>

        {% if current_stats.expense_by_category %}
        <hr>
        <h3 class="h6 text-muted-soft mb-2">–†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:</h3>
        <div class="small">
          {% for cat, amount in current_stats.expense_by_category.items() %}
          <div class="d-flex justify-content-between mb-1">
            <span>{{ cat }}</span>
            <span>{{ amount }} ‚ÇΩ</span>
          </div>
          {% endfor %}
        </div>
        {% endif %}
      </div>
    </div>

    <!-- –§–æ—Ä–º–∞ —Å–∏–º—É–ª—è—Ü–∏–∏ -->
    <div class="col-md-8">
      <div class="fb-card p-4">
        <h2 class="h6 text-muted-soft mb-3">‚öôÔ∏è –ü–ª–∞–Ω–∏—Ä—É–µ–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è</h2>
        
        <form method="post" id="simulation-form">
          <div class="row g-3">
            <!-- –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –¥–æ—Ö–æ–¥–∞ -->
            <div class="col-md-6">
              <label class="form-label">üí∞ –£–≤–µ–ª–∏—á–∏—Ç—å –¥–æ—Ö–æ–¥ –Ω–∞ (‚ÇΩ)</label>
              <input type="number" step="1" name="increase_income" class="form-control" value="0" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 10000">
              <small class="text-muted">–ü–æ–≤—ã—à–µ–Ω–∏–µ, –ø–æ–¥—Ä–∞–±–æ—Ç–∫–∞</small>
            </div>

            <!-- –£–º–µ–Ω—å—à–µ–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–æ–≤ -->
            <div class="col-md-6">
              <label class="form-label">üìâ –£–º–µ–Ω—å—à–∏—Ç—å —Ä–∞—Å—Ö–æ–¥—ã –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</label>
              <select name="reduce_category" class="form-select" id="reduce-cat">
                <option value="">–ù–µ –º–µ–Ω—è—Ç—å</option>
                {% for cat in current_stats.categories %}
                <option value="{{ cat }}">{{ cat }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- –ü—Ä–æ—Ü–µ–Ω—Ç —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è -->
            <div class="col-md-6">
              <label class="form-label">–ù–∞ —Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ —Å–æ–∫—Ä–∞—Ç–∏—Ç—å?</label>
              <input type="number" step="1" name="reduce_percent" class="form-control" value="0" min="0" max="100" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 20">
              <small class="text-muted">–û—Ç 0% –¥–æ 100%</small>
            </div>

            <!-- –ü–µ—Ä–∏–æ–¥ —Å–∏–º—É–ª—è—Ü–∏–∏ -->
            <div class="col-md-6">
              <label class="form-label">‚è±Ô∏è –ü–µ—Ä–∏–æ–¥ —Å–∏–º—É–ª—è—Ü–∏–∏ (–º–µ—Å—è—Ü–µ–≤)</label>
              <select name="simulation_months" class="form-select">
                <option value="3">3 –º–µ—Å—è—Ü–∞</option>
                <option value="6" selected>6 –º–µ—Å—è—Ü–µ–≤</option>
                <option value="12">1 –≥–æ–¥</option>
                <option value="24">2 –≥–æ–¥–∞</option>
              </select>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ -->
            <div class="col-12">
              <button type="submit" class="btn btn-fb-primary btn-lg w-100">
                üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏–º—É–ª—è—Ü–∏—é —Å AI-–∞–Ω–∞–ª–∏–∑–æ–º
              </button>
            </div>
          </div>
        </form>
      </div>

      <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∏–º—É–ª—è—Ü–∏–∏ -->
      {% if result %}
      <div class="fb-card p-4 mt-4">
        <h2 class="h5 mb-3">üìà –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∏–º—É–ª—è—Ü–∏–∏</h2>
        
        <div class="row g-3 mb-4">
          <div class="col-md-4">
            <div class="text-center p-3 rounded" style="background: rgba(76, 175, 80, 0.1);">
              <p class="mb-1 text-muted-soft small">–ù–æ–≤—ã–π –¥–æ—Ö–æ–¥</p>
              <p class="h4 text-income mb-0">{{ result.new_income }} ‚ÇΩ</p>
            </div>
          </div>
          <div class="col-md-4">
            <div class="text-center p-3 rounded" style="background: rgba(244, 67, 54, 0.1);">
              <p class="mb-1 text-muted-soft small">–ù–æ–≤—ã–π —Ä–∞—Å—Ö–æ–¥</p>
              <p class="h4 text-expense mb-0">{{ result.new_expense }} ‚ÇΩ</p>
            </div>
          </div>
          <div class="col-md-4">
            <div class="text-center p-3 rounded" style="background: rgba(255, 193, 7, 0.1);">
              <p class="mb-1 text-muted-soft small">–ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å</p>
              <p class="h4 mb-0">{{ result.new_balance }} ‚ÇΩ</p>
            </div>
          </div>
        </div>

        <div class="alert alert-success">
          <h3 class="h6 mb-2">üéØ –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–π</h3>
          <p class="mb-0">–ó–∞ {{ result.months }} –º–µ—Å—è—Ü–µ–≤ –≤—ã –Ω–∞–∫–æ–ø–∏—Ç–µ: <strong>{{ result.projected_savings }} ‚ÇΩ</strong></p>
          {% if result.savings_increase_percent > 0 %}
          <p class="mb-0 small">–≠—Ç–æ –Ω–∞ <strong>{{ result.savings_increase_percent|round(1) }}%</strong> –±–æ–ª—å—à–µ, —á–µ–º —Å–µ–π—á–∞—Å!</p>
          {% endif %}
        </div>

        <!-- AI –ê–Ω–∞–ª–∏–∑ –æ—Ç DeepSeek -->
        <div class="alert alert-info">
          <div class="d-flex align-items-start">
            <span class="me-3" style="font-size: 2rem;">ü§ñ</span>
            <div>
              <h3 class="h6 mb-2">AI-–ê–Ω–∞–ª–∏–∑ –æ—Ç DeepSeek</h3>
              <div class="ai-analysis-text" style="white-space: pre-line;">{{ result.gpt_advice }}</div>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<style>
.ai-analysis-text {
  line-height: 1.6;
  color: #e0e0e0;
}
</style>
{% endblock %}
