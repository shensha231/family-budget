{% extends "base.html" %}
{% block title %}–î–∞—à–±–æ—Ä–¥ ¬∑ Family Budget{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="row g-4">
    <!-- –°–¢–ê–¢–ò–°–¢–ò–ö–ê -->
    <div class="col-md-4">
      <div class="fb-card p-4 h-100">
        <h2 class="h6 text-muted-soft mb-3">–¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü</h2>
        <p class="mb-1">–î–æ—Ö–æ–¥—ã:</p>
        <p class="h4 text-income mb-3">{{ total_income or 0 }} ‚ÇΩ</p>
        <p class="mb-1">–†–∞—Å—Ö–æ–¥—ã:</p>
        <p class="h4 text-expense mb-3">{{ total_expense or 0 }} ‚ÇΩ</p>
        <p class="mb-0 text-muted-soft">
          –ë–∞–ª–∞–Ω—Å: {{ (total_income or 0) - (total_expense or 0) }} ‚ÇΩ
        </p>
      </div>
    </div>

    <!-- –§–û–†–ú–ê –î–û–ë–ê–í–õ–ï–ù–ò–Ø + AI -->
    <div class="col-md-8">
      <!-- –ë–´–°–¢–†–´–ï –ö–ê–¢–ï–ì–û–†–ò–ò -->
      <div class="mb-3">
        <div class="d-flex gap-2 flex-wrap">
          <button type="button" class="btn btn-outline-secondary btn-sm quick-cat" data-cat="–ü—Ä–æ–¥—É–∫—Ç—ã">
            üõí –ü—Ä–æ–¥—É–∫—Ç—ã
          </button>
          <button type="button" class="btn btn-outline-secondary btn-sm quick-cat" data-cat="–ö–∞—Ñ–µ">
            ‚òï –ö–∞—Ñ–µ
          </button>
          <button type="button" class="btn btn-outline-secondary btn-sm quick-cat" data-cat="–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç">
            üöó –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç
          </button>
          <button type="button" class="btn btn-outline-secondary btn-sm quick-cat" data-cat="–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è">
            üé¨ –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è
          </button>
        </div>
      </div>

      <div class="fb-card p-4 mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2 class="h6 mb-0 text-muted-soft">–î–æ–±–∞–≤–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é</h2>
        </div>

        <form method="post" action="{{ url_for('transactions.add_transaction') }}" class="row g-3" id="transaction-form">
          <div class="col-md-3">
            <label class="form-label">–¢–∏–ø</label>
            <select name="type" class="form-select" required id="type-select">
              <option value="expense" selected>–†–∞—Å—Ö–æ–¥</option>
              <option value="income">–î–æ—Ö–æ–¥</option>
            </select>
          </div>

          <div class="col-md-3">
            <label class="form-label">–°—É–º–º–∞ ‚ÇΩ</label>
            <input type="number" step="0.01" name="amount" class="form-control" required id="amount-input" placeholder="0">
          </div>

          <div class="col-md-3">
            <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
            <input type="text" name="category" class="form-control" placeholder="–ï–¥–∞, –∂–∏–ª—å—ë..." required id="category-input">
          </div>

          <div class="col-md-3">
            <label class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
            <input type="text" name="description" class="form-control" placeholder="–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ">
          </div>

          <!-- AI –ü–û–î–°–ö–ê–ó–ö–ê -->
          <div class="col-12" id="ai-tip" style="display:none;">
            <div class="alert alert-info d-flex align-items-start">
              <span class="me-2">ü§ñ</span>
              <div id="ai-tip-text"></div>
            </div>
          </div>

          <div class="col-12">
            <button type="submit" class="btn btn-fb-primary">
              üí∞ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>
          </div>
        </form>
      </div>

      <!-- –ü–û–°–õ–ï–î–ù–ò–ï –û–ü–ï–†–ê–¶–ò–ò -->
      <div class="fb-card p-4">
        <h2 class="h6 text-muted-soft mb-3">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</h2>
        {% if last_transactions %}
        <div class="table-responsive">
          <table class="table table-dark table-borderless align-middle mb-0">
            <thead class="text-muted-soft">
              <tr>
                <th>–î–∞—Ç–∞</th>
                <th>–¢–∏–ø</th>
                <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                <th class="text-end">–°—É–º–º–∞</th>
              </tr>
            </thead>
            <tbody>
              {% for t in last_transactions %}
              <tr>
                <td>{{ t.date.strftime('%d.%m.%Y') }}</td>
                <td>
                  {% if t.type == 'income' %}
                  <span class="text-income">–î–æ—Ö–æ–¥</span>
                  {% else %}
                  <span class="text-expense">–†–∞—Å—Ö–æ–¥</span>
                  {% endif %}
                </td>
                <td>{{ t.category }}</td>
                <td>{{ t.description or '-' }}</td>
                <td class="text-end">
                  {% if t.type == 'income' %}
                  <span class="text-income">+{{ t.amount }} ‚ÇΩ</span>
                  {% else %}
                  <span class="text-expense">-{{ t.amount }} ‚ÇΩ</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <p class="mb-0 text-muted-soft">–ü–æ–∫–∞ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
// –î–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞
const userMonthlyIncome = {{ total_income or 50000 }};

// –ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
document.querySelectorAll('.quick-cat').forEach(btn => {
  btn.addEventListener('click', function() {
    document.getElementById('category-input').value = this.dataset.cat;
    document.getElementById('amount-input').focus();
  });
});

// AI –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø—Ä–∏ –≤–≤–æ–¥–µ –∫—Ä—É–ø–Ω–æ–π —Å—É–º–º—ã
let tipTimeout;
document.getElementById('amount-input').addEventListener('input', function() {
  clearTimeout(tipTimeout);
  const amount = parseFloat(this.value);
  const category = document.getElementById('category-input').value;
  
  if (amount > 5000 && category) {
    tipTimeout = setTimeout(async () => {
      try {
        const response = await fetch('/api/get-spending-tip', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            amount: amount, 
            category: category, 
            monthly_income: userMonthlyIncome
          })
        });
        
        const data = await response.json();
        if (data.tip) {
          document.getElementById('ai-tip').style.display = 'block';
          document.getElementById('ai-tip-text').textContent = data.tip;
        }
      } catch (e) {
        console.log('AI tip request failed:', e);
      }
    }, 1000);
  } else {
    document.getElementById('ai-tip').style.display = 'none';
  }
});
</script>
{% endblock %}
