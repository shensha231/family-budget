import os
from openai import OpenAI
from datetime import datetime

client = OpenAI(
    api_key=os.getenv("DEEPSEEK_API_KEY"),
    base_url="https://api.deepseek.com"
)

def generate_smart_advice(user_data):
    """
    Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÑ‚ Ð¿ÐµÑ€ÑÐ¾Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ ÑÐ¾Ð²ÐµÑ‚Ñ‹ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ Ð¿Ð¾Ð»Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
    """
    prompt = f"""
Ð¢Ñ‹ â€” Ñ„Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ð¹ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸Ðº-ÐºÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ð½Ñ‚. ÐŸÑ€Ð¾Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐ¹ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¾ ÑÐµÐ¼ÐµÐ¹Ð½Ð¾Ð¼ Ð±ÑŽÐ´Ð¶ÐµÑ‚Ðµ:

ðŸ“Š Ð”ÐžÐ¥ÐžÐ”Ð«:
{user_data.get('income_summary', 'ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…')}

ðŸ’¸ Ð ÐÐ¡Ð¥ÐžÐ”Ð« ÐŸÐž ÐšÐÐ¢Ð•Ð“ÐžÐ Ð˜Ð¯Ðœ:
{user_data.get('expense_breakdown', 'ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…')}

ðŸ’° ÐžÐ‘Ð©ÐÐ¯ Ð˜ÐÐ¤ÐžÐ ÐœÐÐ¦Ð˜Ð¯:
- ÐžÐ±Ñ‰Ð¸Ð¹ Ð´Ð¾Ñ…Ð¾Ð´: {user_data.get('total_income', 0)} â‚½
- ÐžÐ±Ñ‰Ð¸Ð¹ Ñ€Ð°ÑÑ…Ð¾Ð´: {user_data.get('total_expense', 0)} â‚½
- Ð‘Ð°Ð»Ð°Ð½Ñ: {user_data.get('balance', 0)} â‚½

ðŸŽ¯ ÐšÐ Ð£ÐŸÐÐ«Ð• Ð ÐÐ¡Ð¥ÐžÐ”Ð« (>10000 â‚½):
{user_data.get('large_expenses', 'ÐÐµÑ‚ ÐºÑ€ÑƒÐ¿Ð½Ñ‹Ñ… Ñ€Ð°ÑÑ…Ð¾Ð´Ð¾Ð²')}

Ð—ÐÐ”ÐÐÐ˜Ð•:
1. ÐŸÑ€Ð¾Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐ¹ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ñ€Ð°ÑÑ…Ð¾Ð´Ð¾Ð² Ð¸ Ð½Ð°Ð¹Ð´Ð¸ Ð°Ð½Ð¾Ð¼Ð°Ð»Ð¸Ð¸
2. Ð”Ð°Ð¹ 3-5 ÐšÐžÐÐšÐ Ð•Ð¢ÐÐ«Ð¥, ÐžÐ Ð˜Ð“Ð˜ÐÐÐ›Ð¬ÐÐ«Ð¥ ÑÐ¾Ð²ÐµÑ‚Ð¾Ð² (Ð½Ðµ Ð±Ð°Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ "Ð¼ÐµÐ½ÑŒÑˆÐµ Ñ‚Ñ€Ð°Ñ‚ÑŒÑ‚Ðµ")
3. Ð•ÑÐ»Ð¸ ÐµÑÑ‚ÑŒ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ñ "Ð ÐµÑÑ‚Ð¾Ñ€Ð°Ð½Ñ‹/Ð•Ð´Ð° Ð²Ð½Ðµ Ð´Ð¾Ð¼Ð°" Ñ Ð±Ð¾Ð»ÑŒÑˆÐ¸Ð¼Ð¸ Ñ‚Ñ€Ð°Ñ‚Ð°Ð¼Ð¸:
   - ÐŸÐ¾ÑÑ‡Ð¸Ñ‚Ð°Ð¹ Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚ Ð¾Ñ‚ Ð´Ð¾Ñ…Ð¾Ð´Ð°
   - ÐŸÑ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ 2-3 Ð²ÐºÑƒÑÐ½Ñ‹Ñ… Ð´Ð¾Ð¼Ð°ÑˆÐ½Ð¸Ñ… Ñ€ÐµÑ†ÐµÐ¿Ñ‚Ð° ÐºÐ°Ðº Ð°Ð»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ñƒ
   - ÐŸÐ¾ÐºÐ°Ð¶Ð¸ ÑÐºÐ¾Ð½Ð¾Ð¼Ð¸ÑŽ Ð² Ñ†Ð¸Ñ„Ñ€Ð°Ñ…
4. ÐŸÑ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ Ñ€ÐµÐ°Ð»Ð¸ÑÑ‚Ð¸Ñ‡Ð½Ñ‹Ð¹ Ð¿Ð»Ð°Ð½ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð½Ð° Ð¼ÐµÑÑÑ†

ÐžÑ‚Ð²ÐµÑ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð¿Ñ€Ð°ÐºÑ‚Ð¸Ñ‡Ð½Ñ‹Ð¼, Ð¼Ð¾Ñ‚Ð¸Ð²Ð¸Ñ€ÑƒÑŽÑ‰Ð¸Ð¼ Ð¸ Ñ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¼Ð¸ Ñ†Ð¸Ñ„Ñ€Ð°Ð¼Ð¸!
"""
    
    try:
        response = client.chat.completions.create(
            model="deepseek-chat",
            messages=[
                {"role": "system", "content": "Ð¢Ñ‹ Ð¾Ð¿Ñ‹Ñ‚Ð½Ñ‹Ð¹ Ñ„Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ð¹ ÐºÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ð½Ñ‚, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð´Ð°ÐµÑ‚ Ð¿Ñ€Ð°ÐºÑ‚Ð¸Ñ‡Ð½Ñ‹Ðµ ÑÐ¾Ð²ÐµÑ‚Ñ‹ Ñ ÑŽÐ¼Ð¾Ñ€Ð¾Ð¼ Ð¸ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¼Ð¸ Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ð°Ð¼Ð¸."},
                {"role": "user", "content": prompt}
            ],
            temperature=0.8,
            max_tokens=2000
        )
        return response.choices[0].message.content
    except Exception as e:
        return f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ ÑÐ¾Ð²ÐµÑ‚Ð¾Ð²: {str(e)}"


def analyze_transaction(transaction_data):
    """
    ÐœÐ¾Ð¼ÐµÐ½Ñ‚Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð°Ð½Ð°Ð»Ð¸Ð· Ð¾Ð´Ð½Ð¾Ð¹ Ñ‚Ñ€Ð°Ð½Ð·Ð°ÐºÑ†Ð¸Ð¸ Ð¿Ñ€Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ð¸
    Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ ÑÐ¾Ð²ÐµÑ‚ ÑÑ€Ð°Ð·Ñƒ Ð¿Ð¾ÑÐ»Ðµ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ñ€Ð°ÑÑ…Ð¾Ð´Ð°
    """
    amount = transaction_data.get('amount', 0)
    category = transaction_data.get('category', '')
    user_income = transaction_data.get('user_monthly_income', 0)
    
    if amount == 0 or user_income == 0:
        return None
    
    percentage = (amount / user_income) * 100
    
    # ÐÐ½Ð°Ð»Ð¸Ð· Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ ÐºÑ€ÑƒÐ¿Ð½Ñ‹Ñ… Ñ€Ð°ÑÑ…Ð¾Ð´Ð¾Ð² (>5% Ð¾Ñ‚ Ð´Ð¾Ñ…Ð¾Ð´Ð°)
    if percentage < 5:
        return None
        
    prompt = f"""
ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‡Ñ‚Ð¾ Ð¿Ð¾Ñ‚Ñ€Ð°Ñ‚Ð¸Ð» {amount} â‚½ Ð½Ð° ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑŽ "{category}".
Ð•Ð³Ð¾ Ð¼ÐµÑÑÑ‡Ð½Ñ‹Ð¹ Ð´Ð¾Ñ…Ð¾Ð´: {user_income} â‚½ (ÑÑ‚Ð¾ {percentage:.1f}% Ð¾Ñ‚ Ð´Ð¾Ñ…Ð¾Ð´Ð°).

Ð”Ð°Ð¹ ÐžÐ”Ð˜Ð ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ð¹ ÑÐ¾Ð²ÐµÑ‚ (2-3 Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ):
- Ð•ÑÐ»Ð¸ ÑÑ‚Ð¾ Ð¼Ð½Ð¾Ð³Ð¾ â€” Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½ÑƒÑŽ Ð°Ð»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ñƒ
- Ð•ÑÐ»Ð¸ Ð½Ð¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ð¾ â€” Ð¿Ð¾Ñ…Ð²Ð°Ð»Ð¸ Ð¸ Ð´Ð°Ð¹ ÑÐ¾Ð²ÐµÑ‚ ÐºÐ°Ðº ÑÑÐºÐ¾Ð½Ð¾Ð¼Ð¸Ñ‚ÑŒ Ð² ÑÑ‚Ð¾Ð¹ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸

Ð‘ÑƒÐ´ÑŒ Ð´Ñ€ÑƒÐ¶ÐµÐ»ÑŽÐ±Ð½Ñ‹Ð¼ Ð¸ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¼!
"""
    
    try:
        response = client.chat.completions.create(
            model="deepseek-chat",
            messages=[{"role": "user", "content": prompt}],
            temperature=0.7,
            max_tokens=150
        )
        return response.choices[0].message.content
    except:
        return None
